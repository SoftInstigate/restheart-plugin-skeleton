version: "3"

### Creates a named network with the default bridge driver
# The network is shared between restheart and mongodb only
# See: https://docs.docker.com/engine/userguide/networking/dockernetworks/
# See: https://docs.docker.com/engine/reference/commandline/network_create/
networks:
   restheart-backend:

### Create a permanent, named data volume
# This makes much easier to identify where the mongodb data is stored on host
# See: https://docs.docker.com/engine/userguide/containers/dockervolumes/#mount-a-shared-storage-volume-as-a-data-volume
volumes:
   restheart-mongo-volume:

services:
    restheart:
        build:
            context: ./docker
        container_name: restheart
        restart: always
        depends_on:
            - mongodb
        networks:
            - restheart-backend
        ports:
            - "8080:8080"
            - "4000:4000"
        volumes:
            - ./etc/:/opt/restheart/etc:ro
            - ./target/restheart-plugin-skeleton.jar:/opt/restheart/plugins/restheart-plugin-skeleton.jar:ro
            - ./target/lib/.:/opt/restheart/lib:ro
    mongodb:
        image: mongo:4.2
        container_name: restheart-mongo
        command: ["--bind_ip", "restheart-mongo", "--auth", "--replSet", "rs0"]
        environment:
            MONGO_INITDB_DATABASE: restheart
            MONGO_INITDB_ROOT_USERNAME: restheart
            MONGO_INITDB_ROOT_PASSWORD: R3ste4rt!
        volumes:
            - restheart-mongo-volume:/data/db
            - ./docker/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
        networks:
            - restheart-backend

### Initiate MongoDB as a single node replica set
    mongodb-initiate:
      image: mongo:4.2
      networks:
         - restheart-backend
      depends_on:
         - mongodb
      entrypoint: bash -c "for i in {1..100}; do mongo  --host mongodb --username restheart --password 'R3ste4rt!' --eval 'if (!rs.status().ok) rs.initiate();' && break || sleep 2; done"
