<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>org.restheart</groupId>
    <artifactId>restheart-examples</artifactId>
    <version>1.0.0-SNAPSHOT</version>
  </parent>
  <artifactId>service-plugin</artifactId>
  <packaging>jar</packaging>

  <properties>
    <mongodb.version>4.2</mongodb.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.restheart</groupId>
      <artifactId>restheart-commons</artifactId>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>io.fabric8</groupId>
        <artifactId>docker-maven-plugin</artifactId>
        <version>0.34.1</version>
        <configuration>
          <watchInterval>10000</watchInterval>
          <watchMode>both</watchMode>
          <removeVolumes>true</removeVolumes>
          <images>
            <image>
              <alias>mongo</alias>
              <name>mongo:${mongodb.version}</name>
              <run>
                <env>
                  <MONGO_INITDB_DATABASE>restheart</MONGO_INITDB_DATABASE>
                  <MONGO_INITDB_ROOT_USERNAME>restheart</MONGO_INITDB_ROOT_USERNAME>
                  <MONGO_INITDB_ROOT_PASSWORD>R3ste4rt!</MONGO_INITDB_ROOT_PASSWORD>
                </env>
                <cmd>--bind_ip 0.0.0.0 --auth --replSet rs0</cmd>
                <volumes>
                  <bind>
                    <volume>etc/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d</volume>
                  </bind>
                </volumes>
                <wait>
                  <log>waiting for connections on port</log>
                  <time>10000</time>
                </wait>
              </run>
              <watch>
                <mode>none</mode>
              </watch>
            </image>
            <image>
              <alias>mongo-initiate</alias>
              <name>mongo:${mongodb.version}</name>
              <run>
                <entrypoint>
                  <exec>
                    <arg>bash</arg>
                    <arg>-c</arg>
                    <arg>
                      <![CDATA[for i in {1..100}; do mongo --host mongo --username restheart --password 'R3ste4rt!' --eval 'if (!rs.status().ok) rs.initiate();' && break || sleep 2; done;]]>
                    </arg>
                  </exec>
                </entrypoint>
                <links>
                  <link>mongo</link>
                </links>
              </run>
              <watch>
                <mode>none</mode>
              </watch>
            </image>
            <image>
              <alias>restheart</alias>
              <name>softinstigate/microd:${project.version}</name>
              <build>
                <from>softinstigate/restheart:latest</from>
                <assembly>
                  <inline>
                    <fileSets>
                      <includes>
                        <include>src/main/resources/watcher.txt</include>
                      </includes>
                    </fileSets>
                  </inline>
                </assembly>
              </build>
              <run>
                <env>
                  <MONGO_URI>mongodb://restheart:R3ste4rt!@mongo</MONGO_URI>
                </env>
                <cmd>-e /opt/restheart/etc/default.properties</cmd>
                <ports>
                  <port>8080:8080</port>
                </ports>
                <links>
                  <link>mongo</link>
                </links>
                <volumes>
                  <bind>
                    <volume>target/service-plugin.jar:/opt/restheart/plugins/service-plugin.jar</volume>
                  </bind>
                </volumes>
                <wait>
                  <log>RESTHeart started</log>
                  <time>60000</time>
                </wait>
              </run>
              <watch>
                <mode>both</mode>
                <interval>5000</interval>
              </watch>
            </image>
          </images>
        </configuration>
        <!-- <executions>
          <execution>
            <id>start</id>
            <phase>fizzed-watcher</phase>
            <goals>
              <goal>run</goal>
            </goals>
          </execution>
          <execution>
            <id>stop</id>
            <phase>post-integration-test</phase>
            <goals>
              <goal>stop</goal>
            </goals>
          </execution>
        </executions> -->
      </plugin>
      <plugin>
        <groupId>com.fizzed</groupId>
        <artifactId>fizzed-watcher-maven-plugin</artifactId>
        <version>1.0.6</version>
        <configuration>
          <touchFile>src/main/resources/watcher.txt</touchFile>
          <watches>
            <watch>
              <directory>src/main/java</directory>
            </watch>
          </watches>
          <goals>
            <goal>package</goal>
          </goals>
          <!--
          <profiles>
              <profile>optional-profile-to-activate</profile>
          </profiles>
          -->
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>